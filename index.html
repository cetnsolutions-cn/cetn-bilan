<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
  <title>C&N Solutions ‚Äì Gestion</title>
  <link href="https://fonts.googleapis.com/css?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* ===== THEME STABLE ===== */
    body { background: #f4f6fa; margin:0; font-family:'Inter',sans-serif; color:#232a38; -webkit-font-smoothing:antialiased; }
    * { box-sizing:border-box; }
    input, select, button { outline:none; -webkit-appearance:none; }

    .wrap { max-width:1100px; margin:0 auto; background:#fff; min-height:100vh; padding:15px; position:relative; }
    @media(min-width:768px){ .wrap{ margin:20px auto; border-radius:12px; min-height:auto; box-shadow:0 4px 20px rgba(0,0,0,0.05); padding:24px; } }

    /* Header */
    .head { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:15px; }
    .title { font-size:1.4rem; font-weight:900; color:#1b47b7; margin:0; }
    .live-area { display:flex; align-items:center; gap:10px; }
    .live { display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#1a7b32; font-weight:700; background:#e8f8ef; padding:4px 10px; border-radius:99px; }
    .dot { width:8px; height:8px; background:#1bd24e; border-radius:50%; }

    /* Onglets */
    .tabs { display:flex; gap:10px; margin-bottom:20px; background:#eef3fa; padding:5px; border-radius:10px; }
    .tab { flex:1; padding:10px; border:none; background:transparent; font-weight:700; color:#1c4bc7; cursor:pointer; border-radius:8px; text-align:center; }
    .tab.active { background:#1977f2; color:#fff; }

    /* Dashboard */
    .dash { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px; }
    .card { flex:1 1 180px; background:#f7faff; border:1px solid #e1ecff; border-radius:12px; padding:15px; }
    .card-label { font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; margin-bottom:4px; }
    .card-value { font-size:1.4rem; font-weight:800; color:#1647a8; }
    .card-tva { background:#fffbeb; border-color:#fcd34d; }
    .card-tva .card-label { color:#92400e; }
    .card-tva .card-value { color:#b45309; }

    /* Boutons */
    .btns { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:15px; position:sticky; top:5px; z-index:10; background:rgba(255,255,255,0.9); padding:5px 0; }
    .btn { padding:10px 14px; border-radius:8px; font-weight:700; border:none; cursor:pointer; font-size:13px; display:inline-flex; align-items:center; gap:6px; }
    .btn-primary { background:#1977f2; color:#fff; }
    .btn-light { background:#f1f6ff; color:#1b47b7; border:1px solid #cfe0ff; }
    .btn-tva { background:#fffbeb; color:#92400e; border:1px solid #fcd34d; }
    .btn-settings { background:#f3f4f6; color:#374151; border:1px solid #d1d5db; }

    /* Formulaire */
    .form-wrap { background:#f8fbff; border:1px solid #bed1f2; border-radius:12px; padding:12px; margin-bottom:15px; }
    .form-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .rdv-block { background:#fff; border:1px solid #cfe0ff; border-radius:8px; padding:8px; display:flex; gap:6px; align-items:center; margin-bottom:6px; width:100%; }
    input, select { padding:10px; border:1px solid #bed1f2; border-radius:8px; font-size:14px; background:#fff; }
    
    /* Bouton Report */
    .btn-report-off { background:#f1f5f9; color:#64748b; border:1px solid #cbd5e1; padding:8px; border-radius:6px; font-weight:700; font-size:12px; cursor:pointer; width:100%; text-align:center; }
    .btn-report-on { background:#fff7ed; color:#ea580c; border:1px solid #fed7aa; padding:8px; border-radius:6px; font-weight:700; font-size:12px; cursor:pointer; width:100%; text-align:center; }

    /* Table Ajust√©e Mobile */
    .monthbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:10px; background:#f9fafb; padding:8px; border-radius:8px; }
    .monthbar input[type="date"] { padding:8px; border:1px solid #d1d5db; border-radius:6px; }
    .table-wrap { overflow-x:auto; border:1px solid #e5e7eb; border-radius:10px; }
    
    table { width:100%; border-collapse:collapse; min-width:100%; }
    th { background:#f3f4f6; color:#374151; font-weight:700; padding:10px; font-size:12px; text-align:left; border-bottom:2px solid #e5e7eb; }
    td { padding:12px 10px; border-bottom:1px solid #f3f4f6; font-size:13px; vertical-align: middle; }
    .text-right { text-align:right; }
    
    .pill-report { background:#fff7ed; color:#ea580c; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:800; border:1px solid #fed7aa; display:inline-block; margin-top:2px; }
    .geste-chip { background:#dcfce7; color:#166534; padding:2px 6px; border-radius:4px; font-size:11px; font-weight:800; border:1px solid #bbf7d0; display:inline-block; }

    /* Pagination */
    .pager { display:flex; justify-content:flex-end; gap:5px; margin-top:10px; align-items:center; }
    .pager button { padding:6px 12px; border-radius:6px; background:#fff; border:1px solid #ccc; cursor:pointer; font-size:12px; }
    .pager span { font-size:12px; font-weight:bold; }

    /* Modales */
    .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:100; align-items:center; justify-content:center; }
    .modal-box { background:#fff; width:95%; max-width:800px; border-radius:12px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.2); max-height:90vh; overflow-y:auto; }
    .modal-head { display:flex; justify-content:space-between; margin-bottom:15px; align-items:center; }
    .modal-title { font-weight:800; font-size:1.1rem; color:#1e3a8a; }

    /* Checkbox TVA */
    .tva-option { display:flex; align-items:center; gap:10px; padding:15px; border:2px solid #e5e7eb; border-radius:10px; cursor:pointer; transition:0.2s; }
    .tva-option.checked { border-color:#16a34a; background:#f0fdf4; color:#166534; }
    .tva-option i { font-size:1.2rem; color:#d1d5db; }
    .tva-option.checked i { color:#16a34a; }

    /* Mobile et Tableaux */
    @media(min-width:769px){
        .hide-desktop { display: none; }
    }
    @media(max-width:768px){
      .wrap{ padding:10px; margin:0; border-radius:0; min-height:100vh; }
      .rdv-block{ flex-wrap:wrap; }
      .clientSel, .commWrap{ width:100%; }
      .monthbar select { flex:1; }
      
      /* Style Tableau Mobile "Comme la photo" */
      .hide-mobile { display:none !important; }
      .show-mobile { display:table-cell !important; }
      
      table { table-layout: fixed; }
      th, td { padding: 10px 4px; font-size: 11px; white-space: normal; word-wrap: break-word; }
      
      /* Colonne Date */
      th:nth-child(2), td:nth-child(2) { width: 65px; } 
      /* Colonne Agence */
      th:nth-child(3), td:nth-child(3) { width: auto; font-weight:700; color:#374151; line-height:1.2; }
      /* Colonne RDV */
      th:nth-child(4), td:nth-child(4) { width: 30px; text-align:center; }
      /* Colonne TTC/Etat */
      th:nth-child(5), td:nth-child(5) { width: 60px; text-align:right; font-weight:800; }
      /* Colonne Action */
      th:last-child, td:last-child { width: 40px; text-align:center; }
      
      .btn-circle-mob { width:28px; height:28px; border-radius:50%; padding:0; display:flex; align-items:center; justify-content:center; border:1px solid #e2e8f0; background:#fff; color:#64748b; }
    }
  </style>
</head>
<body>

  <div id="lockScreen" style="position:fixed; inset:0; background:#111827; display:flex; align-items:center; justify-content:center; z-index:9999;">
    <div style="background:#fff; padding:30px; border-radius:16px; width:300px; text-align:center;">
      <h2 style="margin:0 0 20px 0; color:#1e40af;">Connexion</h2>
      <input type="password" id="pwLogin" placeholder="Mot de passe" style="width:100%; margin-bottom:10px;">
      <button class="btn btn-primary" style="width:100%; justify-content:center;" onclick="tryLogin()">Entrer</button>
      <div id="lockErr" style="color:red; margin-top:10px; font-size:12px;"></div>
    </div>
  </div>

  <div class="wrap" id="app" style="display:none">
    <div class="head">
      <div class="title">C&N Solutions</div>
      <div class="live-area">
        <div class="live"><span class="dot" id="liveDot"></span> Connect√©</div>
        <button onclick="openSettingsModal()" class="btn btn-settings" style="padding:6px 10px; border-radius:99px" title="R√©glages">
          ‚öôÔ∏è
        </button>
        <button onclick="changePassword()" class="btn btn-light" style="padding:6px 10px; border-radius:99px" title="Changer mot de passe">
          üîê
        </button>
      </div>
    </div>

    <div class="tabs">
      <button id="tabRdv" class="tab active" onclick="switchTab('rdv')">Facturation</button>
      <button id="tabClients" class="tab" onclick="switchTab('clients')">R√©pertoire</button>
    </div>

    <div id="section-rdv" class="section active">
      
      <div class="dash" id="dashboard"></div>

      <div class="btns">
        <button class="btn btn-primary" onclick="showBilanCommercial()">
          <i class="fa-solid fa-chart-pie"></i> Bilan Commercial
        </button>
        <button class="btn btn-light" onclick="exportMonthPdfAll()">
          <i class="fa-solid fa-file-pdf"></i> PDF Global
        </button>
      </div>

      <div class="form-wrap">
        <form id="rdvForm">
          <div class="form-row" style="margin-bottom:10px;">
            <input type="date" id="dateSelect" required style="flex:1;">
            <div style="flex:1; min-width:160px;">
              <button type="button" id="btnCreateReport" class="btn-report-off" onclick="toggleCreateReport()">NON (Mois en cours)</button>
              <input type="hidden" id="chkReportVal" value="false">
            </div>
          </div>
          <div id="rdvBlocks"></div>
          <button type="button" class="btn btn-light" style="width:100%; margin-bottom:8px; justify-content:center;" onclick="addRdvBlock()">+ Ajouter ligne</button>
          <button type="submit" class="btn btn-primary" style="width:100%; justify-content:center;">Enregistrer</button>
        </form>
        <div id="notif" style="text-align:center; margin-top:8px; font-weight:700; color:#15803d;"></div>
      </div>

      <div class="monthbar">
        <input type="date" id="filtreJour" title="Jour pr√©cis" onchange="renderTable()" style="max-width:130px;">
        <label>Mois:</label> <select id="moisFiltre"></select>
        <label>Agence:</label> <select id="filtreAgence"></select>
        <label>Comm:</label> <select id="filtreCommercial"></select>
        <button class="btn btn-light" onclick="clearFilters()">Effacer</button>
        <button class="btn" style="background:#fee2e2; color:#b91c1c; border-color:#fca5a5;" onclick="deleteSelected()">Suppr.</button>
      </div>
      
      <div class="table-wrap">
        <table>
          <thead id="tableHead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="pager" class="pager"></div>
    </div>
    <div id="section-clients" style="display:none">
      <div class="form-wrap">
        <form id="clientForm" class="form-row">
          <input type="text" id="clientAgence" placeholder="Nom Agence" style="flex:2">
          <input type="text" id="clientCommerciaux" placeholder="Commerciaux (ex: Jean, Paul)" style="flex:2">
          <input type="number" id="clientTarif" placeholder="Tarif (‚Ç¨)" style="width:100px">
          <button type="submit" class="btn btn-primary">Sauvegarder</button>
          <input type="hidden" id="clientEditId">
        </form>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
              <tr>
                  <th>Agence</th>
                  <th class="hide-mobile">Commerciaux</th>
                  <th class="hide-mobile">Tarif</th>
                  <th class="text-right">Actions</th>
              </tr>
          </thead>
          <tbody id="tbodyClients"></tbody>
        </table>
      </div>
    </div>
    </div>

  <div id="settingsModal" class="modal-overlay">
    <div class="modal-box" style="max-width:500px">
      <div class="modal-head">
        <div class="modal-title">R√©glages & TVA</div>
        <button onclick="closeModal('settingsModal')" style="background:none; border:none; font-size:24px;">√ó</button>
      </div>
      
      <div style="margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
        <label style="font-weight:700; display:block; margin-bottom:5px;">Logo (Haut PDF)</label>
        <div style="display:flex; align-items:center; gap:10px;">
           <img id="logoPreview" style="width:50px; height:50px; object-fit:contain; border:1px solid #eee; display:none;">
           <input type="file" accept="image/*" onchange="handleLogo(this)">
           <input type="hidden" id="logoBase64">
        </div>
      </div>

      <div style="margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
        <label style="font-weight:700; display:block; margin-bottom:5px;">Cachet / Signature (Bas PDF)</label>
        <div style="display:flex; align-items:center; gap:10px;">
           <img id="sigPreview" style="width:80px; height:40px; object-fit:contain; border:1px solid #eee; display:none;">
           <input type="file" accept="image/*" onchange="handleSignature(this)">
           <input type="hidden" id="sigBase64">
        </div>
      </div>

      <div class="tva-option" id="tvaOptionBox" onclick="toggleTvaBox()">
        <i id="tvaCheckIcon" class="fa-regular fa-circle"></i>
        <div style="flex:1;">
          <div style="font-weight:700;">Assujetti √† la TVA</div>
          <div style="font-size:12px; opacity:0.7;">Activer le calcul automatique</div>
        </div>
        <input type="checkbox" id="tvaActive" style="display:none;">
      </div>

      <div id="tvaFields" style="display:none; margin-top:15px; background:#f9fafb; padding:15px; border-radius:8px;">
         <label style="font-size:12px; font-weight:700;">Taux de TVA (%)</label>
         <input type="number" id="tvaRate" value="20" style="width:100%; margin-top:5px;">
         
         <label style="font-size:12px; font-weight:700; display:block; margin-top:10px;">Date d√©but TVA</label>
         <input type="date" id="tvaStart" style="width:100%; margin-top:5px;">
         <div style="font-size:11px; color:#6b7280; margin-top:2px;">(La TVA s'appliquera aux RDV apr√®s cette date)</div>
      </div>

      <div style="margin-top:20px; text-align:center;">
        <button class="btn btn-primary" style="width:100%; justify-content:center;" onclick="saveSettings()">Enregistrer tout</button>
      </div>
    </div>
  </div>

  <div id="editModal" class="modal-overlay">
    <div class="modal-box" style="max-width:500px">
      <div class="modal-head">
        <div class="modal-title">Modifier RDV</div>
        <button onclick="closeModal('editModal')" style="background:none; border:none; font-size:24px;">√ó</button>
      </div>
      <input type="hidden" id="editId">
      
      <div style="display:grid; gap:12px;">
        <div>
          <label style="font-size:12px; font-weight:700; color:#666;">Date</label>
          <input type="date" id="editDate" style="width:100%;">
        </div>
        <div>
          <label style="font-size:12px; font-weight:700; color:#666;">Agence</label>
          <input type="text" id="editAgence" readonly style="width:100%; background:#f3f4f6;">
        </div>
        <div style="display:flex; gap:10px;">
           <div style="flex:1;">
             <label style="font-size:12px; font-weight:700; color:#666;">Commercial</label>
             <select id="editComm" style="width:100%;"></select>
           </div>
           <div style="width:80px;">
             <label style="font-size:12px; font-weight:700; color:#666;">Tarif</label>
             <input type="number" id="editTarif" style="width:100%;">
           </div>
        </div>
        <div>
           <label style="font-size:12px; font-weight:700; color:#666;">Nombre RDV</label>
           <input type="number" id="editRdv" style="width:100%; font-size:1.2rem; font-weight:800; text-align:center;">
        </div>
        
        <div style="background:#fff7ed; padding:10px; border-radius:8px; border:1px solid #fed7aa;">
           <label style="font-size:11px; font-weight:800; color:#c2410c; margin-bottom:5px; display:block;">FACTURATION</label>
           <button type="button" id="btnEditReport" class="btn-report-off" onclick="toggleEditReport()">NON (Mois en cours)</button>
           <input type="hidden" id="editReportVal">
        </div>

        <button class="btn btn-primary" style="width:100%; justify-content:center; padding:12px;" onclick="saveEdit()">Valider</button>
        
        <button class="btn btn-light" style="width:100%; margin-top:10px;" onclick="exportSingleRdvPdf()">üìÑ T√©l√©charger PDF (Ce RDV)</button>
      </div>
    </div>
  </div>

  <div id="bilanModal" class="modal-overlay">
    <div class="modal-box" style="max-width:800px;">
      <div class="modal-head">
        <div class="modal-title">Bilans Commerciaux</div>
        <button onclick="closeModal('bilanModal')" style="background:none; border:none; font-size:24px;">√ó</button>
      </div>
      <div style="display:flex; gap:10px; margin-bottom:15px;">
         <button id="btnBilanMonth" class="btn btn-primary" style="flex:1; justify-content:center;" onclick="setBilanPeriod('month')">Mois</button>
         <button id="btnBilanYear" class="btn btn-light" style="flex:1; justify-content:center;" onclick="setBilanPeriod('year')">Ann√©e</button>
      </div>
      <div id="bilanContent" style="display:flex; flex-direction:column; gap:15px;"></div>
    </div>
  </div>

<script>
/* ================= CONFIG ================= */
const firebaseConfig={apiKey:"AIzaSyC99x3m-J0M14YWL_PhD3-X8GyZTXwkfes",authDomain:"bilan-rdv-pro.firebaseapp.com",projectId:"bilan-rdv-pro",storageBucket:"bilan-rdv-pro.appspot.com",messagingSenderId:"453220474263",appId:"1:453220474263:web:e1226ff79656af1eee78d2"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

const MONTHS_FR=["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];
const pad=n=>String(n).padStart(2,'0');
const fmt=n=>{ let x=Number(n||0).toFixed(2); return x.replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g," "); };
const todayISO=()=>{const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`};
const monthKey=d=>{if(typeof d==='string')d=new Date(d);return `${d.getFullYear()}-${pad(d.getMonth()+1)}`;}
const getNextMonthKey=s=>{const d=new Date(s); d.setDate(1); d.setMonth(d.getMonth()+1); return monthKey(d);}
const labelMonth=m=>{if(!m)return'';const[y,mo]=m.split('-');return `${MONTHS_FR[parseInt(mo)-1]} ${y}`;}
const formatDate=s=>{if(!s)return'-';return new Date(s).toLocaleDateString('fr-FR');}

let rows=[], clientsRows=[];
let CONFIG={ tvaActive:false, tvaRate:20, logo:"", signature:"", tvaStart:"" };
let bilanPeriod='month';
let editingId=null;
let currentPage = 1;
const ITEMS_PER_PAGE = 15;

/* ================= AUTH ================= */
async function tryLogin(){
    const pw=document.getElementById('pwLogin').value;
    const h=await sha256(pw);
    const snap=await db.collection('config').doc('access').get();
    if(snap.exists && snap.data().adminHash===h){
        document.getElementById('lockScreen').style.display='none';
        document.getElementById('app').style.display='block';
        loadSettings();
        initListeners();
    } else { document.getElementById('lockErr').textContent="Erreur mot de passe"; }
}
document.getElementById('pwLogin').addEventListener('keyup', e=>{ if(e.key==='Enter') tryLogin(); });
async function sha256(m){const b=new TextEncoder().encode(m);const h=await crypto.subtle.digest('SHA-256',b);return Array.from(new Uint8Array(h)).map(x=>x.toString(16).padStart(2,'0')).join('');}
async function changePassword(){
    const p=prompt("Nouveau mot de passe ?"); if(!p)return;
    const h=await sha256(p); await db.collection('config').doc('access').set({adminHash:h}); alert("Mot de passe modifi√© !");
}

/* ================= SETTINGS ================= */
async function loadSettings(){
    try{
        const d=await db.collection('config').doc('settings').get();
        if(d.exists) CONFIG={...CONFIG, ...d.data()};
    }catch(e){}
    renderTable();
}
function openSettingsModal(){
    document.getElementById('tvaActive').checked = CONFIG.tvaActive;
    refreshTvaBoxUI();
    document.getElementById('tvaRate').value = CONFIG.tvaRate;
    document.getElementById('tvaStart').value = CONFIG.tvaStart;
    document.getElementById('logoBase64').value = CONFIG.logo;
    document.getElementById('sigBase64').value = CONFIG.signature;
    if(CONFIG.logo) { document.getElementById('logoPreview').src=CONFIG.logo; document.getElementById('logoPreview').style.display='block'; }
    if(CONFIG.signature) { document.getElementById('sigPreview').src=CONFIG.signature; document.getElementById('sigPreview').style.display='block'; }
    document.getElementById('settingsModal').style.display='flex';
}
function toggleTvaBox(){
    const chk = document.getElementById('tvaActive'); chk.checked = !chk.checked; refreshTvaBoxUI();
}
function refreshTvaBoxUI(){
    const chk = document.getElementById('tvaActive');
    const box = document.getElementById('tvaOptionBox');
    const icon = document.getElementById('tvaCheckIcon');
    const fields = document.getElementById('tvaFields');
    if(chk.checked){
        box.classList.add('checked'); icon.className = "fa-solid fa-check-circle"; fields.style.display = 'block';
    } else {
        box.classList.remove('checked'); icon.className = "fa-regular fa-circle"; fields.style.display = 'none';
    }
}
function handleLogo(inp){
    if(inp.files[0]){
        const r=new FileReader();
        r.onload=e=>{ document.getElementById('logoPreview').src=e.target.result; document.getElementById('logoPreview').style.display='block'; document.getElementById('logoBase64').value=e.target.result; };
        r.readAsDataURL(inp.files[0]);
    }
}
function handleSignature(inp){
    if(inp.files[0]){
        const r=new FileReader();
        r.onload=e=>{ document.getElementById('sigPreview').src=e.target.result; document.getElementById('sigPreview').style.display='block'; document.getElementById('sigBase64').value=e.target.result; };
        r.readAsDataURL(inp.files[0]);
    }
}
async function saveSettings(){
    CONFIG.tvaActive = document.getElementById('tvaActive').checked;
    CONFIG.tvaRate = Number(document.getElementById('tvaRate').value);
    CONFIG.tvaStart = document.getElementById('tvaStart').value;
    CONFIG.logo = document.getElementById('logoBase64').value;
    CONFIG.signature = document.getElementById('sigBase64').value;
    await db.collection('config').doc('settings').set(CONFIG, {merge:true});
    closeModal('settingsModal'); renderTable();
}

/* ================= DATA ================= */
function initListeners(){
    db.collection('clients').onSnapshot(s=>{
        clientsRows=[]; s.forEach(d=>clientsRows.push({id:d.id,...d.data()}));
        clientsRows.sort((a,b)=>(a.agence||"").localeCompare(b.agence||""));
        renderClientsTable();
    });
    db.collection('rdv_ajouts').onSnapshot(s=>{
        document.getElementById('liveDot').style.background='#1bd24e';
        rows=[]; s.forEach(d=>{
            const r=d.data(); r.total=Number(r.total||(r.rdv*r.tarif)); r.netTotal=Math.max(0,r.total-(r.geste?r.gesteMontant:0)); rows.push({id:d.id,...r});
        });
        if(!document.getElementById('moisFiltre').value) buildMonthOptions('moisFiltre');
        renderTable();
    });
}

/* ================= SAISIE ================= */
function toggleCreateReport(){
    const btn = document.getElementById('btnCreateReport');
    const inp = document.getElementById('chkReportVal');
    if(inp.value === "false"){ inp.value = "true"; btn.className = "btn-report-on"; btn.textContent = "OUI (Report M+1)"; } 
    else { inp.value = "false"; btn.className = "btn-report-off"; btn.textContent = "NON (Mois en cours)"; }
}
function addRdvBlock(){
    const d=document.createElement('div'); d.className='rdv-block';
    d.innerHTML=`<select class="clientSel" style="flex:2" onchange="onClientChange(this)"></select>
                 <div class="commWrap" style="flex:2;display:flex;gap:4px"></div>
                 <input type="number" class="tarifIn" placeholder="‚Ç¨" style="width:60px">
                 <button type="button" onclick="this.parentElement.remove()" style="color:#ef4444;font-weight:bold;border:none;background:none">√ó</button>`;
    document.getElementById('rdvBlocks').appendChild(d);
    fillClientSelect(d.querySelector('.clientSel'));
}
function fillClientSelect(s){ s.innerHTML=`<option value="">Agence...</option>`+clientsRows.map(c=>`<option value="${c.id}">${c.agence}</option>`).join(''); }
function onClientChange(sel){
    const cli=clientsRows.find(c=>c.id===sel.value);
    const wrap=sel.parentElement.querySelector('.commWrap');
    const tarif=sel.parentElement.querySelector('.tarifIn');
    wrap.innerHTML='';
    if(cli){
        if(cli.tarif) tarif.value=cli.tarif;
        if(cli.commerciaux && cli.commerciaux.length>0){
            addCommLine(wrap,cli.commerciaux);
            const btn=document.createElement('button'); btn.type='button'; btn.textContent='+'; btn.style.padding='2px 6px';
            btn.onclick=()=>addCommLine(wrap,cli.commerciaux);
            wrap.appendChild(btn);
        } else { wrap.innerHTML=`<input type="number" class="rdvVal" value="1" style="width:50px" placeholder="Nb">`; }
    }
}
function addCommLine(wrap,list){
    const d=document.createElement('div');
    d.innerHTML=`<select class="commSel"><option value="">-</option>${list.map(x=>`<option>${x}</option>`).join('')}</select><input type="number" class="rdvVal" value="5" style="width:40px">`;
    wrap.insertBefore(d,wrap.firstChild);
}
document.getElementById('rdvForm').onsubmit=async(e)=>{
    e.preventDefault();
    const date=document.getElementById('dateSelect').value;
    if(!date)return alert("Date requise");
    const isReport = document.getElementById('chkReportVal').value === "true";
    const targetMonth=isReport?getNextMonthKey(date):monthKey(date);
    const batch=db.batch();
    document.querySelectorAll('.rdv-block').forEach(b=>{
        const cliId=b.querySelector('.clientSel').value;
        const cli=clientsRows.find(c=>c.id===cliId);
        if(!cli) return;
        const tarif=Number(b.querySelector('.tarifIn').value);
        const comms=b.querySelectorAll('.commSel');
        if(comms.length>0){
            comms.forEach(c=>{
                const name=c.value; const nb=Number(c.nextElementSibling.value);
                if(name && nb>0) addBatch(batch,cli,name,nb,tarif,date,targetMonth,isReport);
            });
        } else {
            const nb=Number(b.querySelector('.rdvVal').value);
            if(nb>0) addBatch(batch,cli,"",nb,tarif,date,targetMonth,isReport);
        }
    });
    await batch.commit();
    document.getElementById('rdvBlocks').innerHTML=''; addRdvBlock();
    document.getElementById('chkReportVal').value = "false";
    document.getElementById('btnCreateReport').className = "btn-report-off";
    document.getElementById('btnCreateReport').textContent = "NON (Mois en cours)";
    buildMonthOptions('moisFiltre');
}
function addBatch(batch,cli,comm,rdv,tarif,date,targetMonth,isReport){
    const ref=db.collection('rdv_ajouts').doc();
    batch.set(ref,{
        clientId:cli.id, agence:cli.agence, commercial:comm, rdv, tarif,
        total:rdv*tarif, date, periodDate:date, periodMonth:targetMonth,
        reporte:isReport, geste:false, createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });
}

/* ================= CALCULS TVA ================= */
function isTvaApplicable(rDate){
    if(!CONFIG.tvaActive) return false;
    if(!CONFIG.tvaStart) return false;
    return rDate >= CONFIG.tvaStart;
}
function getLineVals(r){
    const applicable = isTvaApplicable(r.date);
    const ht = r.netTotal; 
    const tva = applicable ? (ht * CONFIG.tvaRate / 100) : 0;
    return { ht, tva, ttc: ht + tva, applicable };
}

/* ================= TABLE & FILTER ================= */
function getFilteredData(ignoreFilters=false){
    const jour = document.getElementById('filtreJour').value;
    const m = document.getElementById('moisFiltre').value;
    const ag = document.getElementById('filtreAgence').value;
    const co = document.getElementById('filtreCommercial').value;
    let data = rows.filter(r => {
        if(jour) return (r.date === jour || r.periodDate === jour);
        const billingM = r.periodMonth || monthKey(r.date);
        const activityM = monthKey(r.periodDate || r.date);
        return (billingM === m) || (activityM === m && r.reporte);
    });
    if(!ignoreFilters){
        if(ag) data=data.filter(r=>r.agence===ag);
        if(co) data=data.filter(r=>r.commercial===co);
    }
    return data.sort((a,b)=>a.date.localeCompare(b.date));
}

function changePage(delta) { currentPage += delta; renderTable(); }

function renderTable(){
    const tbody=document.getElementById('tbody');
    const thead=document.getElementById('tableHead');
    tbody.innerHTML='';
    
    // HEADERS ADAPT√âS MOBILE
    let h=`<tr>
             <th style="width:30px" class="hide-mobile"><input type="checkbox" onclick="toggleAll(this)"></th>
             <th>Date</th>
             <th>Agence</th>
             <th class="hide-mobile">Comm.</th>
             <th class="text-right">RDV</th>
             <th class="text-right hide-mobile">Tarif</th>`;
    
    if(CONFIG.tvaActive) {
        h+=`<th class="text-right hide-mobile">HT</th><th class="text-right hide-mobile">TVA</th>`;
    }
    
    // Si TVA, on montre TTC, sinon on montre le total Net (HT)
    // Pour que √ßa tienne sur mobile, on appellera la colonne "TTC" ou "Total"
    h+=`<th class="text-right">Total</th>`; 
    h+=`<th class="text-right">Actions</th></tr>`;
    
    thead.innerHTML=h;
    
    const data=getFilteredData();
    renderDashboard(data);
    
    const totalPages = Math.ceil(data.length / ITEMS_PER_PAGE);
    if(currentPage < 1) currentPage = 1;
    if(currentPage > totalPages && totalPages > 0) currentPage = totalPages;
    
    const start = (currentPage - 1) * ITEMS_PER_PAGE;
    const pageData = data.slice(start, start + ITEMS_PER_PAGE);
    
    pageData.forEach(r=>{
        const v=getLineVals(r);
        const tr=document.createElement('tr');
        const isFutureBill = (r.periodMonth > document.getElementById('moisFiltre').value);
        if(isFutureBill) { tr.style.opacity = "0.7"; tr.style.background = "#f8fafc"; }

        // CELLULES ADAPT√âES MOBILE
        let html=`<td class="hide-mobile"><input type="checkbox" class="chk" data-id="${r.id}"></td>
                  <td>${formatDate(r.periodDate||r.date)}</td>
                  <td>${r.agence} <div class="hide-mobile" style="font-size:10px;font-weight:normal;color:#666">${r.commercial||''}</div></td>
                  <td class="hide-mobile">${r.commercial||''}</td>
                  <td class="text-right"><b>${r.rdv}</b></td>
                  <td class="text-right hide-mobile">${fmt(r.tarif)}</td>`;
        
        if(CONFIG.tvaActive){
            html+=`<td class="text-right hide-mobile">${fmt(v.ht)}‚Ç¨</td><td class="text-right hide-mobile" style="color:#64748b">${fmt(v.tva)}‚Ç¨</td>`;
        }
        
        // Colonne Total / Etat
        let displayTotal = CONFIG.tvaActive ? v.ttc : v.ht;
        
        let status = "";
        if(r.reporte || isFutureBill) status+=`<div class="pill-report">REPORT√â</div>`;
        if(r.geste) status+=`<div class="geste-chip">-${r.gesteMontant}‚Ç¨</div>`;

        html+=`<td class="text-right">
                  <div>${fmt(displayTotal)}‚Ç¨</div>
                  ${status}
               </td>
               <td class="text-right">
                 <button class="btn btn-light btn-circle-mob" onclick="openEditModal('${r.id}')"><i class="fa-solid fa-pen"></i></button>
               </td>`;
        tr.innerHTML=html;
        tbody.appendChild(tr);
    });
    
    document.getElementById('pager').innerHTML=`
        <button onclick="changePage(-1)" ${currentPage===1?'disabled':''}>Pr√©c.</button> 
        <span>Page ${currentPage} / ${totalPages||1}</span> 
        <button onclick="changePage(1)" ${currentPage>=totalPages?'disabled':''}>Suiv.</button>
    `;
    updateSelects();
}

function renderDashboard(viewData){
    const m = document.getElementById('moisFiltre').value;
    const jour = document.getElementById('filtreJour').value;
    let rdv=0, ht=0, tva=0, ttc=0;
    viewData.forEach(r=>{
        const billingM = r.periodMonth || monthKey(r.date);
        if(jour || billingM === m) {
            rdv+=r.rdv; const v=getLineVals(r); ht+=v.ht; tva+=v.tva; ttc+=v.ttc;
        }
    });
    let h=`<div class="card"><div class="card-label">CA ${CONFIG.tvaActive?'HT':''}</div><div class="card-value">${fmt(ht)}‚Ç¨</div><div class="card-sub">${rdv} RDV</div></div>`;
    if(CONFIG.tvaActive){
        h+=`<div class="card"><div class="card-label">TVA Collect√©e</div><div class="card-value" style="color:#d97706">${fmt(tva)}‚Ç¨</div></div>`;
        h+=`<div class="card"><div class="card-label">Total TTC</div><div class="card-value" style="color:#166534">${fmt(ttc)}‚Ç¨</div></div>`;
    }
    document.getElementById('dashboard').innerHTML=h;
}

/* ================= EDIT MODAL ================= */
function openEditModal(id){
    const r=rows.find(x=>x.id===id);
    document.getElementById('editId').value=id;
    document.getElementById('editDate').value=r.date;
    document.getElementById('editAgence').value=r.agence;
    const cli=clientsRows.find(c=>c.id===r.clientId);
    const s=document.getElementById('editComm');
    s.innerHTML='<option value="">-</option>'+(cli?.commerciaux||[]).map(x=>`<option ${x===r.commercial?'selected':''}>${x}</option>`).join('');
    document.getElementById('editRdv').value=r.rdv;
    document.getElementById('editTarif').value=r.tarif;
    const btn=document.getElementById('btnEditReport');
    const val=document.getElementById('editReportVal');
    val.value = r.reporte ? 'true' : 'false';
    btn.className = r.reporte ? 'btn-report-on' : 'btn-report-off';
    btn.textContent = r.reporte ? 'OUI (Report M+1)' : 'NON (Mois en cours)';
    document.getElementById('editModal').style.display='flex';
}
function toggleEditReport(){
    const btn=document.getElementById('btnEditReport');
    const val=document.getElementById('editReportVal');
    if(val.value==='false'){
        val.value='true'; btn.className='btn-report-on'; btn.textContent='OUI (Report M+1)';
    } else {
        val.value='false'; btn.className='btn-report-off'; btn.textContent='NON (Mois en cours)';
    }
}
async function saveEdit(){
    const id=document.getElementById('editId').value;
    const date=document.getElementById('editDate').value;
    const comm=document.getElementById('editComm').value;
    const rdv=Number(document.getElementById('editRdv').value);
    const tarif=Number(document.getElementById('editTarif').value);
    const isReport=document.getElementById('editReportVal').value==='true';
    const tm=isReport?getNextMonthKey(date):monthKey(date);
    await db.collection('rdv_ajouts').doc(id).update({
        date, periodDate:date, periodMonth:tm, commercial:comm, rdv, tarif, total:rdv*tarif, reporte:isReport
    });
    closeModal('editModal');
}

/* ================= BILANS & PDF ================= */
function setBilanPeriod(p){
    bilanPeriod = p;
    document.getElementById('btnBilanMonth').className = (p==='month' ? 'btn btn-primary' : 'btn btn-light');
    document.getElementById('btnBilanYear').className = (p==='year' ? 'btn btn-primary' : 'btn btn-light');
    showBilanCommercial();
}
function showBilanCommercial(){
    const mm = document.getElementById('moisFiltre').value;
    const year = mm.split('-')[0];
    let data;
    if(bilanPeriod === 'year'){ data = rows.filter(r => (r.periodMonth || monthKey(r.date)).startsWith(year)); } 
    else { data = rows.filter(r => (r.periodMonth || monthKey(r.date)) === mm); }
    let map = {};
    data.forEach(r => {
        let k = r.agence; if(!map[k]) map[k] = {};
        let c = r.commercial || "Autre"; if(!map[k][c]) map[k][c] = {rdv:0, total:0};
        map[k][c].rdv += r.rdv; map[k][c].total += r.netTotal;
    });

    let html = `<div class="table-wrap"><table>
      <thead><tr>
         <th style="background:#fff;border-bottom:2px solid #333">Agence</th>
         <th style="background:#fff;border-bottom:2px solid #333" class="hide-mobile">Commercial</th>
         <th style="background:#fff;border-bottom:2px solid #333" class="text-right">RDV</th>
         <th style="background:#fff;border-bottom:2px solid #333" class="text-right">Total HT</th>
         <th style="background:#fff;border-bottom:2px solid #333" class="text-right">Action</th>
      </tr></thead><tbody>`;
    
    Object.keys(map).sort().forEach(ag => {
        Object.keys(map[ag]).sort().forEach(comm => {
            const d = map[ag][comm];
            html += `<tr>
              <td style="font-weight:700;color:#1e3a8a">${ag} <div class="show-mobile" style="display:none;font-size:10px;font-weight:normal;color:#666">${comm}</div></td>
              <td class="hide-mobile">${comm}</td>
              <td class="text-right"><b>${d.rdv}</b></td>
              <td class="text-right">${fmt(d.total)} ‚Ç¨</td>
              <td class="text-right"><button class="btn btn-light" style="padding:4px 10px;font-size:11px" onclick="exportBilanPdf('commercial','${ag}','${comm}')"><i class="fa-solid fa-file-pdf"></i></button></td>
            </tr>`;
        });
    });
    html += `</tbody></table></div>`;
    
    document.getElementById('bilanContent').innerHTML = html;
    document.getElementById('bilanModal').style.display='flex';
}

function exportBilanPdf(scope, agence, commercial){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: (scope==='commercial')?'landscape':'portrait' });
    const mm = document.getElementById('moisFiltre').value;
    const jour = document.getElementById('filtreJour').value;
    const year = mm.split('-')[0];
    if(CONFIG.logo){ try{ doc.addImage(CONFIG.logo, 'JPEG', 14, 10, 30, 30); }catch(e){} }
    let data, labelP;
    if(jour) {
        data = rows.filter(r => (r.date === jour || r.periodDate === jour));
        labelP = "JOURN√âE DU " + formatDate(jour);
        doc.setFontSize(10); doc.setTextColor(50);
        doc.text("Bonjour, suite √† votre demande, voici le r√©capitulatif des RDV pour cette date.", 14, 20);
    } else {
        if(bilanPeriod === 'year'){ data = rows.filter(r => (r.periodMonth || monthKey(r.date)).startsWith(year)); labelP = "Ann√©e " + year; } 
        else { data = rows.filter(r => (r.periodMonth || monthKey(r.date)) === mm); labelP = labelMonth(mm); }
    }
    if(scope==='agency') data = data.filter(r => r.agence === agence);
    if(scope==='commercial') data = data.filter(r => r.agence === agence && (r.commercial||'Autre') === commercial);

    const totalRDV = data.reduce((acc, r) => acc + r.rdv, 0);
    doc.setFontSize(10); doc.setTextColor(100);
    doc.text(`Nombre de RDV : ${totalRDV}`, 150, 35);
    doc.setFontSize(18); doc.setTextColor(30,58,138); doc.setFont('helvetica','bold');
    doc.text("BILAN DE PRESTATION", 14, 45);
    doc.setFontSize(12); doc.setFont('helvetica','normal'); doc.text(labelP, 14, 52);

    let cols = ['Date', 'Agence', 'Comm.', 'RDV', 'Tarif'];
    if(CONFIG.tvaActive) { cols.push('HT', 'TVA', 'TTC'); } else { cols.push('Total TTC'); }
    cols.push('Note');

    let body = data.map(r => {
        const v = getLineVals(r);
        let row = [formatDate(r.periodDate), r.agence, r.commercial||'', r.rdv, fmt(r.tarif)];
        if(CONFIG.tvaActive) { 
            if(v.applicable) row.push(fmt(v.ht), fmt(v.tva), fmt(v.ttc)); else row.push(fmt(v.ht), "-", fmt(v.ht));
        } else { row.push(fmt(v.ht)); }
        let note = ""; if(r.reporte) note = "REPORT√â"; if(r.geste) note += ` (Geste ${r.gesteMontant}‚Ç¨)`; row.push(note);
        return row;
    });

    doc.autoTable({ head: [cols], body: body, margin: { top: 60 }, theme: 'grid', styles: { fontSize: 9 } });

    let totalHT = data.reduce((acc,r)=> acc + r.netTotal, 0);
    let y = doc.lastAutoTable.finalY + 10; doc.setFontSize(12); doc.setTextColor(0);
    
    // Positionnement des totaux
    if(CONFIG.tvaActive){
        let totTva = data.reduce((acc,r)=> acc + getLineVals(r).tva, 0);
        doc.text(`Total HT : ${fmt(totalHT)} ‚Ç¨`, 14, y);
        doc.text(`TVA : ${fmt(totTva)} ‚Ç¨`, 80, y);
        doc.setFont(undefined, 'bold'); doc.text(`Total TTC : ${fmt(totalHT + totTva)} ‚Ç¨`, 150, y);
    } else {
        doc.setFont(undefined, 'bold'); doc.text(`Total TTC : ${fmt(totalHT)} ‚Ç¨`, 14, y);
    }

    // AJOUT DE LA SIGNATURE EN BAS DU BILAN GLOBAL
    if(CONFIG.signature){
         try{
             let sigY = y + 15; // Un peu en dessous des totaux
             if(sigY > 250) { doc.addPage(); sigY = 20; }
             doc.addImage(CONFIG.signature, 'PNG', 140, sigY, 50, 25);
             doc.setFontSize(8); doc.setFont(undefined, 'normal');
             doc.text("Cachet / Signature :", 140, sigY - 2);
         }catch(e){} 
    }

    doc.save(`Bilan_${scope}_${labelP}.pdf`);
}
function exportMonthPdfAll(){ const prev = bilanPeriod; bilanPeriod = 'month'; exportBilanPdf('global'); bilanPeriod = prev; }

function exportSingleRdvPdf(){
    const id = document.getElementById('editId').value;
    const r = rows.find(x=>x.id===id); if(!r) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const v = getLineVals(r);
    
    if(CONFIG.logo){ try{ doc.addImage(CONFIG.logo, 'JPEG', 14, 10, 30, 30); }catch(e){} }
    doc.setFillColor(30, 58, 138); doc.rect(0, 0, 10, 297, 'F');
    doc.setFontSize(22); doc.setTextColor(30,58,138); doc.setFont('helvetica','bold');
    doc.text("BILAN JOURNALIER", 50, 25);
    doc.setFontSize(10); doc.setTextColor(100); doc.setFont('helvetica','normal');
    doc.text(`Date : ${formatDate(r.date)}`, 50, 32);
    doc.setFontSize(10); doc.setTextColor(50);
    doc.text("Bonjour, suite √† votre demande, ci-joint le r√©capitulatif pour la journ√©e demand√©e.", 50, 45);
    
    const head = [['Date', 'Agence', 'Comm', 'RDV', 'Tarif', (v.applicable ? 'Total HT' : 'Total TTC')]];
    const body = [[ formatDate(r.date), r.agence, r.commercial||'-', r.rdv, fmt(r.tarif)+' ‚Ç¨', fmt(v.ht)+' ‚Ç¨' ]];
    doc.autoTable({ head: head, body: body, startY: 60, margin:{left:20}, theme: 'grid' });
    
    if(CONFIG.signature){ try{ doc.addImage(CONFIG.signature, 'PNG', 20, doc.lastAutoTable.finalY+20, 50, 25); }catch(e){} }
    doc.save(`Bilan_Journalier_${r.agence}_${r.date}.pdf`);
}

/* ================= UTILS DASH & FILTERS ================= */
function buildMonthOptions(id){
    const s=document.getElementById(id); s.innerHTML='';
    let y=2025, m=9; const now=new Date(); const endY=now.getFullYear(), endM=now.getMonth()+2;
    while(y<endY || (y===endY && m<=endM)){ s.add(new Option(labelMonth(`${y}-${pad(m)}`), `${y}-${pad(m)}`)); m++; if(m>12){m=1;y++} }
    s.value=monthKey(now);
}
function updateSelects(){
    const ag=document.getElementById('filtreAgence'); const oldA=ag.value;
    const co=document.getElementById('filtreCommercial'); const oldC=co.value;
    const aList=[...new Set(rows.map(r=>r.agence))].sort();
    const cList=[...new Set(rows.map(r=>r.commercial).filter(x=>x))].sort();
    ag.innerHTML='<option value="">Toutes</option>'+aList.map(x=>`<option>${x}</option>`).join('');
    co.innerHTML='<option value="">Tous</option>'+cList.map(x=>`<option>${x}</option>`).join('');
    ag.value=oldA; co.value=oldC;
}

function renderClientsTable(){
    const tbody = document.getElementById('tbodyClients');
    tbody.innerHTML = clientsRows.map(c=>`<tr>
        <td>${c.agence} <div class="show-mobile" style="display:none;font-size:10px;color:#666">${c.commerciaux?c.commerciaux.join(', '):''}</div></td>
        <td class="hide-mobile">${c.commerciaux?c.commerciaux.join(', '):''}</td>
        <td class="hide-mobile">${c.tarif||''}‚Ç¨</td>
        <td class="text-right">
            <button class="btn btn-light btn-circle-mob" onclick="editClient('${c.id}')"><i class="fa-solid fa-pen"></i></button>
            <button class="btn btn-circle-mob" style="background:#fee2e2;color:#b91c1c;border-color:#fca5a5;margin-left:5px" onclick="deleteClient('${c.id}')"><i class="fa-solid fa-trash"></i></button>
        </td>
    </tr>`).join('');
}
function editClient(id){
    const c=clientsRows.find(x=>x.id===id);
    document.getElementById('clientAgence').value=c.agence;
    document.getElementById('clientCommerciaux').value=c.commerciaux?c.commerciaux.join(','):'';
    document.getElementById('clientTarif').value=c.tarif;
    document.getElementById('clientEditId').value=c.id;
}
async function deleteClient(id){
    if(!confirm("Supprimer cette agence ?")) return;
    await db.collection('clients').doc(id).delete();
}
document.getElementById('clientForm').onsubmit=(e)=>{
    e.preventDefault();
    const id=document.getElementById('clientEditId').value;
    const data={
        agence:document.getElementById('clientAgence').value,
        commerciaux:document.getElementById('clientCommerciaux').value.split(',').map(s=>s.trim()).filter(s=>s),
        tarif:Number(document.getElementById('clientTarif').value)
    };
    if(id) db.collection('clients').doc(id).update(data);
    else db.collection('clients').add(data);
    e.target.reset(); document.getElementById('clientEditId').value='';
}

function switchTab(t){ 
    document.querySelectorAll('.section').forEach(s=>s.style.display='none');
    document.getElementById('section-'+t).style.display='block';
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active');
}
function closeModal(id){ document.getElementById(id).style.display='none'; }
function clearFilters(){ document.getElementById('filtreAgence').value=''; document.getElementById('filtreCommercial').value=''; document.getElementById('filtreJour').value=''; renderTable(); }
async function deleteSelected(){
    if(!confirm('Supprimer ?'))return;
    const batch=db.batch();
    document.querySelectorAll('.chk:checked').forEach(c=>{ batch.delete(db.collection('rdv_ajouts').doc(c.dataset.id)); });
    await batch.commit();
}
function toggleAll(src){ document.querySelectorAll('.chk').forEach(c=>c.checked=src.checked); }

document.getElementById('moisFiltre').addEventListener('change',renderTable);
document.getElementById('filtreAgence').addEventListener('change',renderTable);
document.getElementById('filtreCommercial').addEventListener('change',renderTable);

window.onload=checkAccess;
async function checkAccess(){
    document.getElementById('lockScreen').style.display='flex';
}
</script>
</body>
</html>
