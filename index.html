<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
  <title>C&N Solutions ‚Äì Gestion</title>
  <link href="https://fonts.googleapis.com/css?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* ===== THEME GLASS ===== */
    html,body{background: linear-gradient(135deg,#f8fafc, #eff6ff 45%, #eef2ff 100%); margin:0;padding:0;width:100%;min-height:100vh;font-family:'Inter',sans-serif; color:#1e293b}
    *{box-sizing:border-box}
    input, select, textarea, button { -webkit-appearance: none; appearance: none; outline:none; }

    .wrap {
      width:100%;max-width:1200px;margin:20px auto;
      background: rgba(255,255,255,.9); border:1px solid #dbeafe; border-radius:24px;
      box-shadow: 0 25px 60px rgba(30,64,175,.12); backdrop-filter: saturate(180%) blur(10px);
      padding:20px 24px; min-height:90vh;
    }

    /* Header */
    .head {display:flex;align-items:center;justify-content:space-between;margin-bottom:16px; padding-bottom:16px; border-bottom:1px solid #e2e8f0}
    .title { font-size:1.5rem; font-weight:900; background: linear-gradient(90deg,#1e40af,#4f46e5); -webkit-background-clip:text; background-clip:text; color:transparent; }
    .live-area { display:flex; align-items:center; gap:10px; }
    .live { padding:6px 12px;border-radius:99px;background:#ecfdf5;border:1px solid #bbf7d0;color:#166534;font-weight:700; font-size:13px; display:flex;align-items:center;gap:6px }
    .dot{width:8px;height:8px;border-radius:50%;background:#1bd24e;box-shadow:0 0 0 3px rgba(27,210,78,.15); animation: pulse 1.5s infinite;}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(.9)}100%{transform:scale(1)}}

    /* Onglets */
    .tabs{display:flex;gap:8px;padding:6px;background:#f1f5f9;border-radius:16px;margin-bottom:20px}
    .tab{flex:1;background:transparent;border:none;border-radius:12px;padding:10px;font-weight:700;color:#64748b;cursor:pointer;transition:0.2s}
    /* Correction : Style actif bien visible */
    .tab.active{background:#fff;color:#2563eb;box-shadow:0 4px 12px rgba(0,0,0,0.05)}

    /* Dashboard Cards */
    .dash{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap}
    .card{flex:1 1 200px; background:linear-gradient(180deg,#ffffff,#f8fafc); border:1px solid #e2e8f0; border-radius:16px; padding:16px; box-shadow:0 10px 25px rgba(0,0,0,0.03)}
    .card-label{font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:0.5px}
    .card-value{font-size:1.5rem;font-weight:800;color:#0f172a;margin-top:4px}
    .card-sub{font-size:12px;color:#3b82f6;margin-top:4px}

    /* Boutons */
    .btns{display:flex;gap:8px;flex-wrap:wrap; margin-bottom:16px; position:sticky; top:10px; z-index:20;}
    .btn{padding:10px 16px;border-radius:12px;border:none;font-weight:700;cursor:pointer;transition:0.2s; font-size:14px; display:inline-flex; align-items:center; gap:6px}
    .btn-primary{background:linear-gradient(90deg,#2563eb,#4f46e5);color:#fff;box-shadow:0 4px 12px rgba(37,99,235,0.2)}
    .btn-light{background:#fff;border:1px solid #cbd5e1;color:#334155}
    .btn-tva{background:#fffbeb;border:1px solid #fcd34d;color:#92400e}
    .btn:hover{transform:translateY(-1px)}

    /* Formulaire Saisie */
    .form-wrap{background:#f8fafc;border:1px solid #e2e8f0;border-radius:16px;padding:16px;margin-bottom:20px}
    .form-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input, select{padding:10px;border-radius:10px;border:1px solid #cbd5e1;font-size:14px;background:#fff}
    .rdv-block{display:flex;gap:8px;align-items:center;background:#fff;padding:10px;border-radius:12px;border:1px solid #e2e8f0;margin-top:8px;box-shadow:0 2px 5px rgba(0,0,0,0.02)}
    
    /* Filtres */
    .monthbar{background:#fff;padding:10px;border-radius:14px;border:1px solid #e2e8f0;display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:16px}
    
    /* Table */
    .table-wrap{background:#fff;border-radius:16px;border:1px solid #e2e8f0;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.03)}
    table{width:100%;border-collapse:collapse}
    th{background:#f1f5f9;color:#475569;font-weight:700;padding:12px;text-align:left;font-size:13px;border-bottom:1px solid #e2e8f0}
    td{padding:12px;border-bottom:1px solid #f1f5f9;font-size:13px;color:#334155}
    tr:hover td{background:#f8fafc}
    .text-right{text-align:right}

    /* Status & Chips */
    .pill{padding:4px 10px;border-radius:99px;font-size:11px;font-weight:700}
    .pill-report{background:#fff7ed;color:#ea580c;border:1px solid #fed7aa}
    .geste-chip{padding:2px 8px;border-radius:99px;font-size:11px;font-weight:700;background:#f0fdf4;color:#166534;border:1px solid #bbf7d0}

    /* Modales */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.3);backdrop-filter:blur(3px);z-index:100;align-items:center;justify-content:center}
    .modal-box{background:#fff;width:90%;max-width:600px;border-radius:20px;padding:24px;box-shadow:0 25px 50px rgba(0,0,0,0.2);max-height:85vh;overflow-y:auto}

    /* Boutons Report */
    .btn-report-off { background:#f1f5f9; color:#64748b; border:1px solid #cbd5e1; padding:8px 12px; font-weight:700; border-radius:8px; cursor:pointer; font-size:13px; width:100%}
    .btn-report-on { background:#fff7ed; color:#ea580c; border:1px solid #ea580c; padding:8px 12px; font-weight:700; border-radius:8px; cursor:pointer; font-size:13px; width:100%}

    /* Checkbox TVA */
    .tva-check-box { padding:15px; border-radius:12px; border:2px solid #cbd5e1; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; font-weight:700; font-size:1.1rem; color:#64748b; transition:0.2s }
    .tva-check-box.checked { background:#f0fdf4; border-color:#16a34a; color:#166534; }
    .tva-check-box i { font-size:1.3rem; }

    /* Login */
    #lockScreen{position:fixed;inset:0;background:linear-gradient(135deg,#0f172a,#1e3a8a);display:flex;align-items:center;justify-content:center;z-index:9999}
    .lock-box{background:#fff;border-radius:24px;padding:30px;width:340px;text-align:center;box-shadow:0 25px 50px rgba(0,0,0,0.3)}

    .section{display:none} .section.active{display:block}

    /* ===== MOBILE RESPONSIVE (T√©l√©phone) ===== */
    @media (max-width: 768px) {
      .wrap { margin: 10px; padding: 15px; width: auto; }
      .title { font-size: 1.2rem; }
      .hide-mobile { display: none !important; } /* Cache les colonnes inutiles */
      th, td { padding: 8px 5px; font-size: 11px; }
      .btn { padding: 8px 12px; font-size: 12px; }
      .card { flex: 1 1 100%; } /* Cartes empil√©es */
      .monthbar { flex-direction: column; align-items: stretch; }
      .monthbar select, .monthbar button { width: 100%; }
      .rdv-block { flex-wrap: wrap; }
      .clientSel { width: 100%; margin-bottom: 5px; }
      .commWrap { width: 100%; margin-bottom: 5px; }
    }
  </style>
</head>
<body>

  <div id="lockScreen">
    <div class="lock-box">
      <h3 style="font-size:1.4rem;font-weight:800;margin-bottom:20px;color:#1e293b">Acc√®s S√©curis√©</h3>
      <input type="password" id="pwLogin" placeholder="Mot de passe" style="width:100%;margin-bottom:12px">
      <button onclick="tryLogin()" class="btn btn-primary" style="width:100%;justify-content:center">Entrer</button>
      <div id="lockErr" style="color:#ef4444;font-size:12px;margin-top:10px;font-weight:700"></div>
    </div>
  </div>

  <div class="wrap" id="app" style="display:none">
    <div class="head">
      <div class="title">C&N Solutions</div>
      <div class="live-area">
        <div class="live"><span class="dot" id="liveDot"></span> Connect√©</div>
        <button onclick="changePassword()" class="btn btn-light" style="padding:6px 10px; border-radius:99px" title="Changer mot de passe">
          üîê
        </button>
      </div>
    </div>

    <div class="tabs">
      <button id="tabRdv" class="tab active" onclick="switchTab('rdv')">Facturation & RDV</button>
      <button id="tabClients" class="tab" onclick="switchTab('clients')">R√©pertoire Agences</button>
    </div>

    <div id="section-rdv" class="section active">
      
      <div class="dash" id="dashboard"></div>

      <div class="btns">
        <button class="btn btn-primary" onclick="showBilanCommercial()">
          <i class="fa-solid fa-chart-pie"></i> Bilan Commercial
        </button>
        <button class="btn btn-light" onclick="exportMonthPdfAll()">
          <i class="fa-solid fa-file-pdf"></i> PDF Global
        </button>
        <button class="btn btn-tva" onclick="openTvaModal()">
          <i class="fa-solid fa-percent"></i> TVA
        </button>
      </div>

      <div class="form-wrap">
        <form id="rdvForm">
          <div class="form-row">
            <input type="date" id="dateSelect" required>
            <div style="min-width:180px">
              <button type="button" id="btnCreateReport" class="btn-report-off" onclick="toggleCreateReport()">NON (Mois en cours)</button>
              <input type="hidden" id="chkReportVal" value="false">
            </div>
            <button type="button" class="btn btn-light" onclick="addRdvBlock()">+ Ajouter RDV</button>
          </div>
          <div id="rdvBlocks"></div>
          <button type="submit" class="btn btn-primary" style="margin-top:10px">Enregistrer</button>
        </form>
        <div id="notif" style="margin-top:10px;font-weight:700;color:#166534"></div>
      </div>

      <div class="monthbar">
        <input type="date" id="filtreJour" title="Jour pr√©cis" onchange="renderTable()" style="max-width:130px;">
        
        <label><b>Mois :</b> <select id="moisFiltre"></select></label>
        <label><b>Agence :</b> <select id="filtreAgence"></select></label>
        <label><b>Comm. :</b> <select id="filtreCommercial"></select></label>
        <button class="btn btn-light" onclick="clearFilters()" style="padding:6px 10px;font-size:12px">Effacer</button>
        <button class="btn" style="background:#fee2e2;color:#991b1b;padding:6px 10px;font-size:12px" onclick="deleteSelected()">Suppr. coch√©</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead id="tableHead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="pager" style="margin-top:12px;display:flex;justify-content:flex-end;gap:5px"></div>
    </div>

    <div id="section-clients" class="section">
      <div class="form-wrap">
        <form id="clientForm" class="form-row">
          <input type="text" id="clientAgence" placeholder="Nom Agence" style="flex:2">
          <input type="text" id="clientCommerciaux" placeholder="Commerciaux (ex: Jean, Paul)" style="flex:2">
          <input type="number" id="clientTarif" placeholder="Tarif (‚Ç¨)" style="width:100px">
          <button type="submit" class="btn btn-primary">Sauvegarder</button>
          <input type="hidden" id="clientEditId">
        </form>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Agence</th><th>Commerciaux</th><th>Tarif R√©f.</th><th>Actions</th></tr></thead>
          <tbody id="tbodyClients"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="bilanModal" class="modal-overlay">
    <div class="modal-box">
      <div style="display:flex;justify-content:space-between;margin-bottom:15px">
        <h3 style="font-weight:800;font-size:1.2rem;color:#1e3a8a">Bilan D√©taill√©</h3>
        <button onclick="closeModal('bilanModal')" style="background:none;border:none;font-size:20px;cursor:pointer">√ó</button>
      </div>
      <div style="display:flex;gap:10px;margin-bottom:15px">
        <button id="btnMonth" class="btn btn-primary" onclick="setBilanPeriod('month')">Mois en cours</button>
        <button id="btnYear" class="btn btn-light" onclick="setBilanPeriod('year')">Ann√©e compl√®te</button>
      </div>
      <div id="bilanDetails"></div>
    </div>
  </div>

  <div id="tvaModal" class="modal-overlay">
    <div class="modal-box" style="max-width:400px;text-align:center">
      <h3 style="font-weight:800;margin-bottom:20px">R√©glages TVA</h3>
      
      <div id="tvaBox" class="tva-check-box" onclick="toggleTvaBox()">
        <i id="tvaIcon" class="fa-regular fa-circle"></i>
        <span>Assujetti √† la TVA</span>
        <input type="checkbox" id="tvaActive" style="display:none">
      </div>

      <div id="tvaRateBlock" style="display:none;text-align:left;margin-top:20px">
        <label>Taux (%)</label>
        <input type="number" id="tvaRate" value="20" style="width:100%;font-size:1.2rem;font-weight:bold;text-align:center">
      </div>
      <button class="btn btn-primary" style="width:100%;justify-content:center; margin-top:20px" onclick="saveTvaConfig()">Enregistrer</button>
      <button class="btn btn-light" style="width:100%;justify-content:center;margin-top:8px" onclick="closeModal('tvaModal')">Fermer</button>
    </div>
  </div>

  <div id="editModal" class="modal-overlay">
    <div class="modal-box">
      <div style="display:flex;justify-content:space-between;margin-bottom:15px">
        <h3 style="font-weight:800;font-size:1.2rem;color:#1e3a8a">Modifier RDV</h3>
        <button onclick="closeModal('editModal')" style="background:none;border:none;font-size:20px;cursor:pointer">√ó</button>
      </div>
      <input type="hidden" id="editId">
      
      <div style="display:grid; gap:12px;">
        <div>
          <label style="font-size:12px; font-weight:700; color:#666;">Date</label>
          <input type="date" id="editDate" style="width:100%;">
        </div>
        <div>
          <label style="font-size:12px; font-weight:700; color:#666;">Agence</label>
          <input type="text" id="editAgence" readonly style="width:100%; background:#f3f4f6;">
        </div>
        <div style="display:flex; gap:10px;">
           <div style="flex:1;">
             <label style="font-size:12px; font-weight:700; color:#666;">Commercial</label>
             <select id="editComm" style="width:100%;"></select>
           </div>
           <div style="width:80px;">
             <label style="font-size:12px; font-weight:700; color:#666;">Tarif</label>
             <input type="number" id="editTarif" style="width:100%;">
           </div>
        </div>
        <div>
           <label style="font-size:12px; font-weight:700; color:#666;">Nombre RDV</label>
           <input type="number" id="editRdv" style="width:100%; font-size:1.2rem; font-weight:800; text-align:center;">
        </div>
        
        <div style="background:#fff7ed; padding:10px; border-radius:8px; border:1px solid #fed7aa;">
           <label style="font-size:11px; font-weight:800; color:#c2410c; margin-bottom:5px; display:block;">FACTURATION</label>
           <button type="button" id="btnEditReport" class="btn-report-off" onclick="toggleEditReport()">NON (Mois en cours)</button>
           <input type="hidden" id="editReportVal">
        </div>

        <button class="btn btn-primary" style="width:100%; justify-content:center; padding:12px;" onclick="saveEdit()">Valider</button>
        
        <button class="btn btn-light" style="width:100%; margin-top:10px;" onclick="exportSingleRdvPdf()">üìÑ T√©l√©charger PDF (Ce RDV)</button>
      </div>
    </div>
  </div>

<script>
/* ================= INITIALISATION ================= */
const firebaseConfig={apiKey:"AIzaSyC99x3m-J0M14YWL_PhD3-X8GyZTXwkfes",authDomain:"bilan-rdv-pro.firebaseapp.com",projectId:"bilan-rdv-pro",storageBucket:"bilan-rdv-pro.appspot.com",messagingSenderId:"453220474263",appId:"1:453220474263:web:e1226ff79656af1eee78d2"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

const MONTHS_FR=["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];
const pad=n=>String(n).padStart(2,'0');

const fmt=n=>{
    let x = Number(n||0).toFixed(2);
    let parts = x.split('.');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, " "); 
    return parts.join(',');
};

const todayISO=()=>{const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`};
const monthKey=d=>{if(typeof d==='string')d=new Date(d);return `${d.getFullYear()}-${pad(d.getMonth()+1)}`;}
const getNextMonthKey=s=>{const d=new Date(s); d.setDate(1); d.setMonth(d.getMonth()+1); return monthKey(d);}
const labelMonth=m=>{if(!m)return'';const[y,mo]=m.split('-');return `${MONTHS_FR[parseInt(mo)-1]} ${y}`;}
const formatDate=s=>{if(!s)return'-';return new Date(s).toLocaleDateString('fr-FR');}

let rows=[], clientsRows=[];
let TVA={active:false,rate:20};
let bilanPeriod='month';
let editingId=null;

/* ================= ACCESS & START ================= */
async function tryLogin(){
    const pw=document.getElementById('pwLogin').value;
    const h=await sha256(pw);
    const snap=await db.collection('config').doc('access').get();
    if(snap.exists && snap.data().adminHash===h){
        document.getElementById('lockScreen').style.display='none';
        document.getElementById('app').style.display='block';
        loadTvaConfig();
        initListeners();
    } else { document.getElementById('lockErr').textContent="Erreur mot de passe"; }
}
async function sha256(m){const b=new TextEncoder().encode(m);const h=await crypto.subtle.digest('SHA-256',b);return Array.from(new Uint8Array(h)).map(x=>x.toString(16).padStart(2,'0')).join('');}

async function changePassword(){
    const p = prompt("Nouveau mot de passe ?");
    if(!p) return;
    const h = await sha256(p);
    await db.collection('config').doc('access').set({adminHash:h});
    alert("Mot de passe modifi√© !");
}

async function loadTvaConfig(){
    try{
        const d=await db.collection('config').doc('tva').get();
        if(d.exists){ TVA.active=!!d.data().active; TVA.rate=d.data().rate||20; }
    }catch(e){}
    renderTable();
}

/* --- LOGIQUE MODALE TVA --- */
function openTvaModal(){
    const chk = document.getElementById('tvaActive');
    chk.checked = TVA.active; 
    refreshTvaBoxUI();
    document.getElementById('tvaRate').value = TVA.rate;
    document.getElementById('tvaModal').style.display='flex';
}
function toggleTvaBox(){
    const chk = document.getElementById('tvaActive');
    chk.checked = !chk.checked; 
    refreshTvaBoxUI(); 
}
function refreshTvaBoxUI(){
    const chk = document.getElementById('tvaActive');
    const box = document.getElementById('tvaBox');
    const icon = document.getElementById('tvaIcon');
    const rateBlock = document.getElementById('tvaRateBlock');

    if(chk.checked){
        box.classList.add('checked');
        icon.className = "fa-solid fa-check-circle";
        rateBlock.style.display = 'block';
    } else {
        box.classList.remove('checked');
        icon.className = "fa-regular fa-circle";
        rateBlock.style.display = 'none';
    }
}
function saveTvaConfig(){
    TVA.active = document.getElementById('tvaActive').checked;
    TVA.rate = Number(document.getElementById('tvaRate').value);
    db.collection('config').doc('tva').set(TVA);
    closeModal('tvaModal'); 
    renderTable(); 
}

/* ================= LISTENERS DATA ================= */
function initListeners(){
    db.collection('clients').onSnapshot(s=>{
        clientsRows=[]; s.forEach(d=>clientsRows.push({id:d.id,...d.data()}));
        clientsRows.sort((a,b)=>(a.agence||"").localeCompare(b.agence||""));
        renderClientsTable();
    });

    db.collection('rdv_ajouts').onSnapshot(s=>{
        document.getElementById('liveDot').style.background='#1bd24e';
        rows=[];
        s.forEach(d=>{
            const r=d.data();
            r.total = Number(r.total||(r.rdv*r.tarif));
            r.gesteMontant = r.geste ? Number(r.gesteMontant||0) : 0;
            r.netTotal = Math.max(0, r.total - r.gesteMontant);
            rows.push({id:d.id,...r});
        });
        
        if(!document.getElementById('moisFiltre').value) buildMonthOptions('moisFiltre');
        renderTable();
    });
}

/* ================= SAISIE RDV (AVEC BOUTON REPORT) ================= */
function toggleCreateReport(){
    const btn = document.getElementById('btnCreateReport');
    const inp = document.getElementById('chkReportVal');
    
    if(inp.value === "false"){
        inp.value = "true";
        btn.className = "btn-report-on";
        btn.textContent = "OUI (Report M+1)";
    } else {
        inp.value = "false";
        btn.className = "btn-report-off";
        btn.textContent = "NON (Mois en cours)";
    }
}

function addRdvBlock(){
    const d=document.createElement('div'); d.className='rdv-block';
    d.innerHTML=`<select class="clientSel" style="flex:2" onchange="onClientChange(this)"></select>
                 <div class="commWrap" style="flex:2;display:flex;gap:4px"></div>
                 <input type="number" class="tarifIn" placeholder="‚Ç¨" style="width:60px">
                 <button type="button" onclick="this.parentElement.remove()" style="color:#ef4444;font-weight:bold;border:none;background:none">√ó</button>`;
    document.getElementById('rdvBlocks').appendChild(d);
    fillClientSelect(d.querySelector('.clientSel'));
}
function fillClientSelect(s){
    s.innerHTML=`<option value="">Agence...</option>`+clientsRows.map(c=>`<option value="${c.id}">${c.agence}</option>`).join('');
}
function onClientChange(sel){
    const cli=clientsRows.find(c=>c.id===sel.value);
    const wrap=sel.parentElement.querySelector('.commWrap');
    const tarif=sel.parentElement.querySelector('.tarifIn');
    wrap.innerHTML='';
    if(cli){
        if(cli.tarif) tarif.value=cli.tarif;
        if(cli.commerciaux && cli.commerciaux.length>0){
            addCommLine(wrap,cli.commerciaux);
            const btn=document.createElement('button'); btn.type='button'; btn.textContent='+'; btn.style.padding='2px 6px';
            btn.onclick=()=>addCommLine(wrap,cli.commerciaux);
            wrap.appendChild(btn);
        } else {
            wrap.innerHTML=`<input type="number" class="rdvVal" value="1" style="width:50px" placeholder="Nb">`;
        }
    }
}
function addCommLine(wrap,list){
    const d=document.createElement('div');
    d.innerHTML=`<select class="commSel"><option value="">-</option>${list.map(x=>`<option>${x}</option>`).join('')}</select><input type="number" class="rdvVal" value="5" style="width:40px">`;
    wrap.insertBefore(d,wrap.firstChild);
}

document.getElementById('rdvForm').onsubmit=async(e)=>{
    e.preventDefault();
    const date=document.getElementById('dateSelect').value;
    if(!date)return alert("Date requise");
    
    // Lire la valeur du bouton
    const isReport = document.getElementById('chkReportVal').value === "true";
    const targetMonth=isReport?getNextMonthKey(date):monthKey(date);
    
    const batch=db.batch();
    
    document.querySelectorAll('.rdv-block').forEach(b=>{
        const cliId=b.querySelector('.clientSel').value;
        const cli=clientsRows.find(c=>c.id===cliId);
        if(!cli) return;
        const tarif=Number(b.querySelector('.tarifIn').value);
        const comms=b.querySelectorAll('.commSel');
        
        if(comms.length>0){
            comms.forEach(c=>{
                const name=c.value; const nb=Number(c.nextElementSibling.value);
                if(name && nb>0) addBatch(batch,cli,name,nb,tarif,date,targetMonth,isReport);
            });
        } else {
            const nb=Number(b.querySelector('.rdvVal').value);
            if(nb>0) addBatch(batch,cli,"",nb,tarif,date,targetMonth,isReport);
        }
    });
    
    await batch.commit();
    document.getElementById('rdvBlocks').innerHTML=''; addRdvBlock();
    
    // Reset du bouton report
    document.getElementById('chkReportVal').value = "false";
    document.getElementById('btnCreateReport').className = "btn-report-off";
    document.getElementById('btnCreateReport').textContent = "NON (Mois en cours)";

    buildMonthOptions('moisFiltre');
}
function addBatch(batch,cli,comm,rdv,tarif,date,targetMonth,isReport){
    const ref=db.collection('rdv_ajouts').doc();
    batch.set(ref,{
        clientId:cli.id, agence:cli.agence, commercial:comm, rdv, tarif,
        total:rdv*tarif, date, periodDate:date, periodMonth:targetMonth,
        reporte:isReport, geste:false, createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });
}

/* ================= RENDERING TABLE & CALCULS ================= */
function getLineVals(r){
    const ht = r.netTotal; // Base HT
    const tva = TVA.active ? (ht * TVA.rate / 100) : 0;
    return { ht, tva, ttc: ht + tva };
}

function getFilteredData(ignoreFilters=false){
    const jour = document.getElementById('filtreJour').value;
    const m = document.getElementById('moisFiltre').value;
    const ag = document.getElementById('filtreAgence').value;
    const co = document.getElementById('filtreCommercial').value;

    let data = rows.filter(r => {
        // Filtre Jour Pr√©cis (Prioritaire)
        if(jour) return (r.date === jour || r.periodDate === jour);
        
        // Sinon Filtre Mois (Factur√© ou Activit√© report√©e)
        const billingM = r.periodMonth || monthKey(r.date);
        const activityM = monthKey(r.periodDate || r.date);
        return (billingM === m) || (activityM === m && r.reporte);
    });

    if(!ignoreFilters){
        if(ag) data=data.filter(r=>r.agence===ag);
        if(co) data=data.filter(r=>r.commercial===co);
    }
    return data.sort((a,b)=>a.date.localeCompare(b.date));
}

function renderTable(){
    const tbody=document.getElementById('tbody');
    const thead=document.getElementById('tableHead');
    tbody.innerHTML='';
    
    let h=`<tr><th style="width:30px" class="hide-mobile"><input type="checkbox" onclick="toggleAll(this)"></th>
           <th>Date</th><th>Agence</th><th class="hide-mobile">Comm.</th><th class="text-right">RDV</th><th class="text-right hide-mobile">Tarif</th>`;
    if(TVA.active) h+=`<th class="text-right hide-mobile">HT</th><th class="text-right hide-mobile">TVA</th><th class="text-right">TTC</th>`;
    else h+=`<th class="text-right">Total</th>`;
    h+=`<th>Etat</th><th class="text-right">Actions</th></tr>`;
    thead.innerHTML=h;
    
    const data=getFilteredData();
    renderDashboard(data);
    
    const PAGE=window.curPage||1; const SIZE=15; // 15 par page
    const maxP=Math.ceil(data.length/SIZE)||1;
    if(PAGE>maxP)window.curPage=1;
    
    data.slice((PAGE-1)*SIZE, PAGE*SIZE).forEach(r=>{
        const v=getLineVals(r);
        const tr=document.createElement('tr');
        
        const currentFilter = document.getElementById('moisFiltre').value;
        const isFutureBill = (r.periodMonth > currentFilter);
        
        if(isFutureBill) {
            tr.style.opacity = "0.7";
            tr.style.background = "#f8fafc";
        }

        let html=`<td class="hide-mobile"><input type="checkbox" class="chk" data-id="${r.id}"></td>
                  <td>${formatDate(r.periodDate||r.date)}</td>
                  <td>${r.agence}</td><td class="hide-mobile">${r.commercial||''}</td>
                  <td class="text-right"><b>${r.rdv}</b></td>
                  <td class="text-right hide-mobile">${fmt(r.tarif)}</td>`;
        if(TVA.active) html+=`<td class="text-right hide-mobile">${fmt(v.ht)}‚Ç¨</td><td class="text-right hide-mobile" style="color:#64748b">${fmt(v.tva)}‚Ç¨</td><td class="text-right"><b>${fmt(v.ttc)}‚Ç¨</b></td>`;
        else html+=`<td class="text-right"><b>${fmt(v.ht)}‚Ç¨</b></td>`;
        
        let status = "";
        if(r.reporte || isFutureBill) status+=`<span class="pill pill-report">REPORT√â M+1</span> `;
        if(r.geste) status+=`<span class="geste-chip">-${r.gesteMontant}‚Ç¨</span>`;
        
        html+=`<td>${status}</td>
               <td class="text-right">
                 <button class="btn btn-light" style="padding:4px 8px" onclick="openEditModal('${r.id}')">‚úé</button>
               </td>`;
        tr.innerHTML=html;
        tbody.appendChild(tr);
    });
    
    document.getElementById('pager').innerHTML=`<button onclick="window.curPage=Math.max(1,window.curPage-1);renderTable()" class="btn btn-light">Pr√©c.</button> <span>Page ${PAGE}/${maxP}</span> <button onclick="window.curPage=Math.min(${maxP},window.curPage+1);renderTable()" class="btn btn-light">Suiv.</button>`;
    
    updateSelects();
}

function renderDashboard(viewData){
    const m = document.getElementById('moisFiltre').value;
    const jour = document.getElementById('filtreJour').value;
    let rdv=0, ht=0, tva=0, ttc=0;

    viewData.forEach(r=>{
        // Dashboard ne compte que ce qui est affich√© ET pertinent (jour pr√©cis OU mois factur√©)
        const billingM = r.periodMonth || monthKey(r.date);
        
        if(jour || billingM === m) {
            rdv+=r.rdv; 
            const v=getLineVals(r); ht+=v.ht; tva+=v.tva; ttc+=v.ttc;
        }
    });
    
    let h=`<div class="card"><div class="card-label">CA HT</div><div class="card-value">${fmt(ht)}‚Ç¨</div><div class="card-sub">${rdv} RDV</div></div>`;
    if(TVA.active){
        h+=`<div class="card"><div class="card-label">TVA (${TVA.rate}%)</div><div class="card-value" style="color:#d97706">${fmt(tva)}‚Ç¨</div></div>`;
        h+=`<div class="card"><div class="card-label">Total TTC</div><div class="card-value" style="color:#166534">${fmt(ttc)}‚Ç¨</div></div>`;
    }
    document.getElementById('dashboard').innerHTML=h;
}

/* ================= MODALE EDIT (CRAYON) ================= */
function openEditModal(id){
    const r=rows.find(x=>x.id===id);
    document.getElementById('editId').value=id;
    document.getElementById('editDate').value=r.date;
    document.getElementById('editAgence').value=r.agence;
    
    const cli=clientsRows.find(c=>c.id===r.clientId);
    const s=document.getElementById('editComm');
    s.innerHTML='<option value="">-</option>'+(cli?.commerciaux||[]).map(x=>`<option ${x===r.commercial?'selected':''}>${x}</option>`).join('');
    
    document.getElementById('editRdv').value=r.rdv;
    document.getElementById('editTarif').value=r.tarif;
    
    const btn=document.getElementById('btnEditReport');
    const val=document.getElementById('editReportVal');
    val.value = r.reporte ? 'true' : 'false';
    btn.className = r.reporte ? 'btn-report-on' : 'btn-report-off';
    btn.textContent = r.reporte ? 'OUI (Report M+1)' : 'NON (Mois en cours)';
    
    document.getElementById('editModal').style.display='flex';
}
function toggleEditReport(){
    const btn=document.getElementById('btnEditReport');
    const val=document.getElementById('editReportVal');
    if(val.value==='false'){
        val.value='true'; btn.className='btn-report-on'; btn.textContent='OUI (Report M+1)';
    } else {
        val.value='false'; btn.className='btn-report-off'; btn.textContent='NON (Mois en cours)';
    }
}
async function saveEdit(){
    const id=document.getElementById('editId').value;
    const date=document.getElementById('editDate').value;
    const comm=document.getElementById('editComm').value;
    const rdv=Number(document.getElementById('editRdv').value);
    const tarif=Number(document.getElementById('editTarif').value);
    const isReport=document.getElementById('editReportVal').value==='true';
    const tm=isReport?getNextMonthKey(date):monthKey(date);
    
    await db.collection('rdv_ajouts').doc(id).update({
        date, periodDate:date, periodMonth:tm,
        commercial:comm, rdv, tarif, total:rdv*tarif,
        reporte:isReport
    });
    closeModal('editModal');
}

/* ================= BILANS & PDF (LOGIQUE D'ORIGINE) ================= */
function setBilanPeriod(p){
    bilanPeriod = p;
    document.getElementById('btnMonth').className = (p==='month' ? 'btn btn-primary' : 'btn btn-light');
    document.getElementById('btnYear').className = (p==='year' ? 'btn btn-primary' : 'btn btn-light');
    showBilanCommercial();
}

function showBilanCommercial(){
    const currentFilterMonth = document.getElementById('moisFiltre').value;
    const year = currentFilterMonth.split('-')[0];
    
    let data;
    if(bilanPeriod === 'year'){
        data = rows.filter(r => (r.periodMonth || monthKey(r.date)).startsWith(year));
    } else {
        data = rows.filter(r => (r.periodMonth || monthKey(r.date)) === currentFilterMonth);
    }
    
    let map = {};
    data.forEach(r => {
        let k = r.agence;
        if(!map[k]) map[k] = {};
        let c = r.commercial || "Autre";
        if(!map[k][c]) map[k][c] = {rdv:0, total:0};
        map[k][c].rdv += r.rdv;
        map[k][c].total += r.netTotal;
    });

    // AFFICHAGE RESTAUR√â: Liste Agences > Tableau Commerciaux
    let html = `<div style="display:flex;flex-direction:column;gap:12px">`;
    Object.keys(map).sort().forEach(ag => {
        html += `<div style="background:#f8fafc;padding:10px;border-radius:10px;border:1px solid #e2e8f0">
            <strong style="color:#1e3a8a;display:block;margin-bottom:6px;font-size:1.1rem">${ag}</strong>
            <table style="font-size:12px;width:100%">`;
        Object.keys(map[ag]).sort().forEach(comm => {
            const d = map[ag][comm];
            html += `<tr>
                <td style="width:150px">${comm}</td>
                <td><b>${d.rdv}</b> RDV</td>
                <td>${fmt(d.total)} ‚Ç¨</td>
                <td class="text-right"><button class="btn btn-light" style="padding:2px 8px;font-size:10px" onclick="exportBilanPdf('commercial','${ag}','${comm}')">PDF</button></td>
            </tr>`;
        });
        html += `</table></div>`;
    });
    html += `</div>`;
    
    document.getElementById('bilanDetails').innerHTML = html;
    document.getElementById('bilanModal').style.display='flex';
}

function exportBilanPdf(scope, agence, commercial){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: (scope==='commercial')?'landscape':'portrait' });
    const mm = document.getElementById('moisFiltre').value;
    const jour = document.getElementById('filtreJour').value; // Prise en compte Jour
    const year = mm.split('-')[0];
    
    let data;
    let labelP = "";
    
    // CAS 1 : JOUR PRECIS
    if(jour) {
        data = rows.filter(r => (r.date === jour || r.periodDate === jour));
        labelP = "JOURN√âE DU " + formatDate(jour);
        
        // Texte introductif demand√©
        doc.setFontSize(10);
        doc.setTextColor(50);
        doc.text("Bonjour, suite √† votre demande, voici le r√©capitulatif des RDV pour cette date.", 14, 20);
    } 
    // CAS 2 : P√âRIODE (Mois/Ann√©e)
    else {
        if(bilanPeriod === 'year'){
            data = rows.filter(r => (r.periodMonth || monthKey(r.date)).startsWith(year));
            labelP = "Ann√©e " + year;
        } else {
            data = rows.filter(r => (r.periodMonth || monthKey(r.date)) === mm);
            labelP = labelMonth(mm);
        }
    }
    
    if(scope==='agency') data = data.filter(r => r.agence === agence);
    if(scope==='commercial') data = data.filter(r => r.agence === agence && (r.commercial||'Autre') === commercial);

    // TOTAL RDV PLAC√âS (affich√© en haut)
    const totalRDV = data.reduce((acc, r) => acc + r.rdv, 0);
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text(`Nombre de RDV : ${totalRDV}`, 150, 35);

    doc.setFontSize(18); doc.setTextColor(30,58,138); doc.setFont('helvetica','bold');
    doc.text("BILAN DE PRESTATION", 14, 45);
    doc.setFontSize(12); doc.setFont('helvetica','normal');
    doc.text(labelP, 14, 52);

    let cols = ['Date', 'Agence', 'Comm.', 'RDV', 'Tarif'];
    if(TVA.active) { cols.push('HT'); cols.push('TVA'); cols.push('TTC'); }
    else { cols.push('Total'); }
    cols.push('Note');

    let body = data.map(r => {
        const v = getLineVals(r);
        let row = [formatDate(r.periodDate), r.agence, r.commercial||'', r.rdv, fmt(r.tarif)];
        if(TVA.active) { row.push(fmt(v.ht), fmt(v.tva), fmt(v.ttc)); }
        else { row.push(fmt(v.ht)); }
        
        let note = "";
        if(r.reporte) note = "REPORT√â";
        if(r.geste) note += ` (Geste ${r.gesteMontant}‚Ç¨)`;
        row.push(note);
        return row;
    });

    doc.autoTable({
        head: [cols], body: body, margin: { top: 60 },
        theme: 'grid', styles: { fontSize: 9 },
        didParseCell: (data) => {
            if(data.column.index === cols.length-1 && data.cell.raw.includes('REPORT√â')) 
                data.cell.styles.textColor = [234, 88, 12];
        }
    });

    let totalHT = data.reduce((acc,r)=> acc + r.netTotal, 0);
    let totalTVA = TVA.active ? (totalHT * TVA.rate / 100) : 0;
    
    let y = doc.lastAutoTable.finalY + 10;
    doc.setFontSize(12);
    doc.setTextColor(0);
    doc.text(`Total HT : ${fmt(totalHT)} ‚Ç¨`, 14, y);
    if(TVA.active) {
        doc.text(`TVA (${TVA.rate}%) : ${fmt(totalTVA)} ‚Ç¨`, 80, y);
        doc.setFont(undefined, 'bold');
        doc.text(`Total TTC : ${fmt(totalHT + totalTVA)} ‚Ç¨`, 150, y);
    }
    
    doc.save(`Bilan_${scope}_${labelP}.pdf`);
}

function exportMonthPdfAll(){
    const prev = bilanPeriod;
    bilanPeriod = 'month';
    exportBilanPdf('global');
    bilanPeriod = prev;
}

/* === PDF UNIQUE (CRAYON) === */
function exportSingleRdvPdf(){
    const id = document.getElementById('editId').value;
    const r = rows.find(x=>x.id===id);
    if(!r) return;
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const v = getLineVals(r);
    
    doc.setFontSize(10); doc.setTextColor(50);
    doc.text("Bonjour, suite √† votre demande, ci-joint le r√©capitulatif pour cette mission.", 14, 20);
    
    doc.setFontSize(18); doc.setTextColor(0); doc.setFont('helvetica','bold');
    doc.text("BILAN JOURNALIER", 14, 40);
    doc.setFontSize(12); doc.setFont('helvetica','normal');
    doc.text(`Date : ${formatDate(r.date)}`, 14, 48);
    
    const head = [['Date', 'Agence', 'Comm', 'RDV', 'Tarif', 'Total HT']];
    const body = [[
       formatDate(r.date), r.agence, r.commercial||'-', r.rdv, fmt(r.tarif)+' ‚Ç¨', fmt(v.ht)+' ‚Ç¨'
    ]];
    
    doc.autoTable({ head: head, body: body, startY: 60, theme: 'grid' });
    
    doc.save(`Bilan_Journalier_${r.agence}_${r.date}.pdf`);
}

/* ================= UTILS DASH & FILTERS ================= */
function buildMonthOptions(id){
    const s=document.getElementById(id); s.innerHTML='';
    let y=2025, m=9; 
    const now=new Date(); const endY=now.getFullYear(), endM=now.getMonth()+2;
    while(y<endY || (y===endY && m<=endM)){
        s.add(new Option(`${MONTHS_FR[m-1]} ${y}`, `${y}-${pad(m)}`));
        m++; if(m>12){m=1;y++}
    }
    s.value=monthKey(now);
}
function updateSelects(){
    const ag=document.getElementById('filtreAgence'); const oldA=ag.value;
    const co=document.getElementById('filtreCommercial'); const oldC=co.value;
    const aList=[...new Set(rows.map(r=>r.agence))].sort();
    const cList=[...new Set(rows.map(r=>r.commercial).filter(x=>x))].sort();
    ag.innerHTML='<option value="">Toutes</option>'+aList.map(x=>`<option>${x}</option>`).join('');
    co.innerHTML='<option value="">Tous</option>'+cList.map(x=>`<option>${x}</option>`).join('');
    ag.value=oldA; co.value=oldC;
}

function renderClientsTable(){
    // Restauration affichage R√©pertoire
    const tbody = document.getElementById('tbodyClients');
    tbody.innerHTML = clientsRows.map(c=>`<tr>
        <td>${c.agence}</td>
        <td>${c.commerciaux?c.commerciaux.join(', '):''}</td>
        <td class="hide-mobile">${c.tarif||''}‚Ç¨</td>
        <td><button class="btn btn-light" onclick="editClient('${c.id}')">‚úé</button></td>
    </tr>`).join('');
}
function editClient(id){
    const c=clientsRows.find(x=>x.id===id);
    document.getElementById('clientAgence').value=c.agence;
    document.getElementById('clientCommerciaux').value=c.commerciaux?c.commerciaux.join(','):'';
    document.getElementById('clientTarif').value=c.tarif;
    document.getElementById('clientEditId').value=c.id;
}
document.getElementById('clientForm').onsubmit=(e)=>{
    e.preventDefault();
    const id=document.getElementById('clientEditId').value;
    const data={
        agence:document.getElementById('clientAgence').value,
        commerciaux:document.getElementById('clientCommerciaux').value.split(',').map(s=>s.trim()).filter(s=>s),
        tarif:Number(document.getElementById('clientTarif').value)
    };
    if(id) db.collection('clients').doc(id).update(data);
    else db.collection('clients').add(data);
    e.target.reset(); document.getElementById('clientEditId').value='';
}

/* ================= UTILS UI ================= */
function switchTab(t){
    document.querySelectorAll('.section').forEach(s=>s.style.display='none');
    document.getElementById('section-'+t).style.display='block';
    
    // Gestion Active Class Onglets
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    document.getElementById('tab'+(t.charAt(0).toUpperCase()+t.slice(1))).classList.add('active');
}
function closeModal(id){ document.getElementById(id).style.display='none'; }

document.getElementById('moisFiltre').addEventListener('change',renderTable);
document.getElementById('filtreAgence').addEventListener('change',renderTable);
document.getElementById('filtreCommercial').addEventListener('change',renderTable);
function clearFilters(){ document.getElementById('filtreAgence').value=''; document.getElementById('filtreCommercial').value=''; document.getElementById('filtreJour').value=''; renderTable(); }
async function deleteSelected(){
    if(!confirm('Supprimer ?'))return;
    const batch=db.batch();
    document.querySelectorAll('.chk:checked').forEach(c=>{ batch.delete(db.collection('rdv_ajouts').doc(c.dataset.id)); });
    await batch.commit();
}
function toggleAll(src){ document.querySelectorAll('.chk').forEach(c=>c.checked=src.checked); }

window.onload=checkAccess;
async function checkAccess(){
    document.getElementById('lockScreen').style.display='flex';
}
</script>
</body>
</html>
